app-id: com.github.xournalpp.xournalpp
# The (bigger) Gnome Platform is just a workaround for an issue with custom cursors, see https://github.com/xournalpp/xournalpp/issues/2375#issuecomment-781482931
runtime: org.gnome.Platform
# Lua-lgi does not work yet with Gtk 4 / Gnome 40, see https://github.com/pavouk/lgi/issues/226
runtime-version: '3.38'
sdk: org.gnome.Sdk

add-extensions:
  org.freedesktop.Sdk.Extension.texlive:
    directory: extensions
    subdirectories: true
    no-autodownload: true
    autodelete: true
    version: "20.08"


command: xournalpp
finish-args:
  # X11 + XShm access
  - "--share=ipc"
  - "--socket=x11"
  # Wayland access
  - "--socket=wayland"
  # File access (unfortunately, autosaving will not work properly outside of $XDG_DOCUMENTS_DIR)
  # Also: https://github.com/flathub/com.github.xournalpp.xournalpp/issues/13
  - "--filesystem=host"
  # Sound
  - "--socket=pulseaudio"
  # Allow dconf
  - "--filesystem=xdg-run/dconf"
  - "--filesystem=~/.config/dconf:ro"
  - "--talk-name=ca.desrt.dconf"
  - "--env=DCONF_USER_CONFIG_DIR=.config/dconf"
  # Access to the TeX binaries, taken from https://github.com/flathub/org.texstudio.TeXstudio/blob/d4e27005d20889aa738da129ea6b6b0e5c0a0528/org.texstudio.TeXstudio.yaml#L22
  - --env=PATH=/app/bin:/app/extensions/bin:/app/extensions/bin/x86_64-linux:/app/extensions/bin/aarch64-linux:/usr/bin/
  # Access to the Lua lgi module
  - --env=LUA_PATH=/app/share/lua/5.3/?.lua;/app/share/lua/5.3/?/init.lua;/app/lib/lua/5.3/?.lua;./?.lua;./?/init.lua
  - --env=LUA_CPATH=/app/lib/lua/5.3/?.so;/app/lib/x86_64-linux-gnu/5.3/?.so;/app/lib/lua/5.3/loadall.so;./?.so
    
cleanup:
  - "/include"
  - "/lib/pkgconfig"
  - "/man"
  - "/share/doc"
  - "/share/gtk-doc"
  - "/share/man"
  - "/share/pkgconfig"
  - "*.la"
  - "*.a"
modules:
  - name: lua
    buildsystem: simple
    build-commands:
      - make linux
      - make install INSTALL_TOP="$FLATPAK_DEST"
    sources:
      - type: archive
        url: http://www.lua.org/ftp/lua-5.3.6.tar.gz
        sha1: f27d20d6c81292149bc4308525a9d6733c224fa5
        
  - name: lua-lgi
    buildsystem: simple
    no-autogen: true
    no-make-install: true
    build-commands:
      - make PREFIX="" LUA_VERSION="5.3"
      - make install PREFIX="" LUA_VERSION="5.3" DESTDIR=$FLATPAK_DEST  
    sources: 
      - type: git
        url: https://github.com/pavouk/lgi.git
        commit: 0fdcf8c677094d0c109dfb199031fdbc0c9c47ea
        
  - name: poppler
    buildsystem: cmake-ninja
    config-opts:
      - "-DCMAKE_INSTALL_LIBDIR=/app/lib"
      - "-DCMAKE_INSTALL_INCLUDEDIR=/app/include"
      - "-DENABLE_LIBOPENJPEG=none"
    cleanup:
      - "/bin"
    sources:
      - type: archive
        url: https://poppler.freedesktop.org/poppler-0.86.1.tar.xz
        sha256: af630a277c8e194c31339c5446241834aed6ed3d4b4dc7080311e51c66257f6c
  - name: libzip
    buildsystem: cmake-ninja
    config-opts:
      - "-DCMAKE_INSTALL_LIBDIR=/app/lib"
      - "-DCMAKE_INSTALL_INCLUDEDIR=/app/include"
    cleanup:
      - "/bin"
    sources:
      - type: archive
        url: https://libzip.org/download/libzip-1.5.2.tar.xz
        sha256: b3de4d4bd49a01e0cab3507fc163f88e1651695b6b9cb25ad174dbe319d4a3b4

  - name: libportaudiocpp
    buildsystem: autotools
    config-opts:
      - "--enable-cxx" # compile with c++ headers!!!
    make-args:
        # seem parallel build is broken. At least it breaks for me, locally
        - -j1
    sources:
      - type: git
        url: https://git.assembla.com/portaudio.git
        commit: 396fe4b6699ae929d3a685b3ef8a7e97396139a4
    cleanup:
      - "/include"
      - "/lib/*.a"
      - "/lib/*.la"
      - "/lib/pkgconfig"
      - "/man"
      - "/share/aclocal"
      - "/share/doc"
      - "/share/gtk-doc"
      - "/share/man"
      - "/share/pkgconfig"

  - name: libsndfile
    buildsystem: autotools
    sources:
      - type: archive
        url: http://www.mega-nerd.com/libsndfile/files/libsndfile-1.0.27.tar.gz
        sha256: a391952f27f4a92ceb2b4c06493ac107896ed6c76be9a613a4731f076d30fac0
        
  - name: texlive_extension
    buildsystem: simple
    build-commands:
        - mkdir /app/extensions

  - name: xournalpp
    buildsystem: cmake-ninja
    builddir: true
    sources:
      - type: git
        url: https://github.com/xournalpp/xournalpp
        commit: 9d1277dee22bb095c2db047bb04f89cc837aee3c
        tag: 1.1.0
      - type: patch
        path: 0001-Update-appdata-screenshots.patch
      - type: patch
        path: 0002-Avoid-deprecated-mimetypes-tag.patch
